<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <meta name="author" content="DAOS Project">
    <link rel="canonical" href="http://daos.io/development/">
    <link rel="shortcut icon" href="../img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <title>DAOS for Development - DAOS</title>
    <link href="../css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="../css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="../css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="../css/highlight.css">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="../js/jquery-3.2.1.min.js"></script>
    <script src="../js/bootstrap-3.3.7.min.js"></script>
    <script src="../js/highlight.pack.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '..';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "DAOS for Development", url: "#_top", children: [
          ]},
          {title: "Building DAOS for Development", url: "#building-daos-for-development", children: [
              {title: "Go dependencies", url: "#go-dependencies" },
              {title: "Protobuf Compiler", url: "#protobuf-compiler" },
          ]},
        ];

    </script>
    <script src="../js/base.js"></script> 
</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>



<div class="container-fluid wm-page-content">
  <a name="_top"></a>
    

    

    <h1 id="daos-for-development">DAOS for Development</h1>
<h1 id="building-daos-for-development">Building DAOS for Development</h1>
<p>For development, it is recommended to build and install each dependency in a unique subdirectory. The DAOS build system supports this through the TARGET_PREFIX variable. Once the submodules have been initialized and updated, run the following:</p>
<pre><code>    scons PREFIX=${daos_prefix_path} TARGET_PREFIX=${daos_prefix_path}/opt install --build-deps=yes --config=force
</code></pre>

<p>Installing the components into seperate directories allow to upgrade the components individually replacing --build-deps=yes with --update-prereq={component_name}. This requires change to the environment configuration from before. For automated environment setup, source scons_local/utils/setup_local.sh.</p>
<pre><code>    ARGOBOTS=${daos_prefix_path}/opt/argobots
    CART=${daos_prefix_path}/opt/cart
    HWLOC=${daos_prefix_path}/opt/hwloc
    MERCURY=${daos_prefix_path}/opt/mercury
    PMDK=${daos_prefix_path}/opt/pmdk
    OPA=${daos_prefix_path}/opt/openpa
    FIO=${daos_prefix_path}/opt/fio
    SPDK=${daos_prefix_path}/opt/spdk

    PATH=$CART/bin/:${daos_prefix_path}/bin/:$PATH
</code></pre>

<p>With this approach DAOS would get built using the prebuilt dependencies in ${daos_prefix_path}/opt and required options are saved for future compilations. So, after the first time, during development, a mere "scons --config=force" and "scons --config=force install" would suffice for compiling changes to daos source code.</p>
<p>If you wish to compile DAOS with clang rather than gcc, set COMPILER=clang on the scons command line.   This option is also saved for future compilations.</p>
<h2 id="go-dependencies">Go dependencies</h2>
<p>Developers contributing Go code may need to change the external dependencies located in the src/control/vendor
directory. The DAOS codebase uses <a href="https://github.com/golang/go/wiki/Modules">Go Modules</a> to manage these
dependencies. As this feature is built in to Go distributions starting with version 1.11, no
additional tools are needed to manage dependencies.</p>
<p>Among other benefits, one of the major advantages of using Go Modules is that it removes the requirement
for builds to be done within the $GOPATH, which simplifies our build system and other internal tooling.</p>
<p>While it is possible to use Go Modules without checking a vendor directory into SCM, the DAOS project
continues to use vendored dependencies in order to insulate our build system from transient network
issues and other problems associated with nonvendored builds.</p>
<p>The following is a short list of example workflows. For more details, please refer to
<a href="https://github.com/golang/go/wiki/Modules#quick-start">one</a> of
<a href="https://engineering.kablamo.com.au/posts/2018/just-tell-me-how-to-use-go-modules/">the</a>
<a href="https://blog.golang.org/migrating-to-go-modules">many</a> resources available online.</p>
<pre><code class="bash"># add a new dependency
$ cd ~/daos/src/control # or wherever your daos clone lives
$ go get github.com/awesome/thing
# make sure that github.com/awesome/thing is imported somewhere in the codebase
$ ./run_go_tests.sh
# note that go.mod and go.sum have been updated automatically
#
# when ready to commit and push for review:
$ go mod vendor
$ git commit -a # should pick up go.mod, go.sum, vendor/*, etc.
</code></pre>

<pre><code class="bash"># update an existing dependency
$ cd ~/daos/src/control # or wherever your daos clone lives
$ go get -u github.com/awesome/thing
# make sure that github.com/awesome/thing is imported somewhere in the codebase
$ ./run_go_tests.sh
# note that go.mod and go.sum have been updated automatically
#
# when ready to commit and push for review:
$ go mod vendor
$ git commit -a # should pick up go.mod, go.sum, vendor/*, etc.
</code></pre>

<pre><code class="bash"># replace/remove an existing dependency
$ cd ~/daos/src/control # or wherever your daos clone lives
$ go get github.com/other/thing
# make sure that github.com/other/thing is imported somewhere in the codebase,
# and that github.com/awesome/thing is no longer imported
$ ./run_go_tests.sh
# note that go.mod and go.sum have been updated automatically
#
# when ready to commit and push for review:
$ go mod tidy
$ go mod vendor
$ git commit -a # should pick up go.mod, go.sum, vendor/*, etc.
</code></pre>

<p>In all cases, after updating the vendor directory, it is a good idea to verify that your
changes were applied as expected. In order to do this, a simple workflow is to clear the
caches to force a clean build and then run the test script, which is vendor-aware and
will not try to download missing modules:</p>
<pre><code class="bash">$ cd ~/daos/src/control # or wherever your daos clone lives
$ go clean -modcache -cache
$ ./run_go_tests.sh
$ ls ~/go/pkg/mod # ~/go/pkg/mod should either not exist or be empty
</code></pre>

<h2 id="protobuf-compiler">Protobuf Compiler</h2>
<p>The DAOS control plane infrastructure uses <a href="https://github.com/protocolbuffers/protobuf">Protocol Buffers</a> as the data serialization format for its RPC requests. Not all developers will need to compile the *.proto files, but if Protobuf changes are needed, the developer must regenerate the corresponding C and Go source files using a Protobuf compiler compatible with proto3 syntax.</p>
<h3 id="recommended-versions">Recommended Versions</h3>
<p>The recommended installation method is to clone the git repositories, check out the tagged releases noted below, and install from source. Later versions may work, but are not guaranteed.</p>
<ul>
<li><a href="https://github.com/protocolbuffers/protobuf">Protocol Buffers</a> v3.5.1. <a href="https://github.com/protocolbuffers/protobuf/blob/master/src/README.md">Installation instructions</a>.</li>
<li><a href="https://github.com/protobuf-c/protobuf-c">Protobuf-C</a> v1.3.1. <a href="https://github.com/protobuf-c/protobuf-c/blob/master/README.md">Installation instructions</a>.</li>
<li>gRPC plugin: <a href="https://github.com/golang/protobuf">protoc-gen-go</a> v1.3.4. <strong>Must match the proto version in
src/control/go.mod.</strong> Install the specific version using GIT_TAG instructions
<a href="https://github.com/golang/protobuf/blob/master/README.md">here</a>.</li>
</ul>
<h3 id="compiling-protobuf-files">Compiling Protobuf Files</h3>
<p>The source (.proto) files live under $DAOSREPO/src/proto. The preferred mechanism for generating
compiled C/Go protobuf definitions is to use the Makefile in this directory. Care should be taken
to keep the Makefile updated when source files are added or removed, or generated file destinations
are updated.</p>
<p>Note that the generated files are checked into SCM and are not generated as part of the normal DAOS
build process. This allows developers to ensure that the generated files are correct after any changes
to the source files are made.</p>
<pre><code class="bash">$ cd ~/daos/src/proto # or wherever your daos clone lives
$ make
protoc -I /home/foo/daos/src/proto/mgmt/ --go_out=plugins=grpc:/home/foo/daos/src/control/common/proto/mgmt/ acl.proto
protoc -I /home/foo/daos/src/proto/mgmt/ --go_out=plugins=grpc:/home/foo/daos/src/control/common/proto/mgmt/ mgmt.proto
...
$ git status
...
#       modified:   ../control/common/proto/mgmt/acl.pb.go
#       modified:   ../control/common/proto/mgmt/mgmt.pb.go
...
</code></pre>

<p>After verifying that the generated C/Go files are correct, add and commit them as you would any other
file.</p>

  <br>
    

    <br>
</div>

<footer class="col-md-12 wm-page-content">
      <p>
        <a href="https://github.com/daos-stack/daos/edit/master/docs/development.md">Edit on daos-stack/daos</a>
      </p>
  <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a> using <a href="https://github.com/gristlabs/mkdocs-windmill">Windmill</a> theme by Grist Labs.</p>
</footer>

</body>
</html>